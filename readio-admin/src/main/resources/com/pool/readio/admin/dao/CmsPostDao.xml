<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.pool.readio.admin.dao.CmsPostDao">

  <!-- 帖子基础字段，与 CmsPostMapper 一致 -->
  <resultMap id="PostBaseResultMap" type="com.pool.readio.mbg.model.CmsPost">
    <id column="id" jdbcType="INTEGER" property="id"/>
    <result column="member_id" jdbcType="INTEGER" property="memberId"/>
    <result column="visible" jdbcType="INTEGER" property="visible"/>
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime"/>
    <result column="update_time" jdbcType="TIMESTAMP" property="updateTime"/>
    <result column="publish_time" jdbcType="TIMESTAMP" property="publishTime"/>
    <result column="title" jdbcType="VARCHAR" property="title"/>
    <result column="ip" jdbcType="VARCHAR" property="ip"/>
    <result column="address" jdbcType="VARCHAR" property="address"/>
  </resultMap>

  <!-- 内容块 ResultMap，与 CmsPostContentBlockMapper 一致（order 为 PostgreSQL 保留字） -->
  <resultMap id="ContentBlockResultMap" type="com.pool.readio.mbg.model.CmsPostContentBlock">
    <id column="id" jdbcType="INTEGER" property="id"/>
    <result column="type" jdbcType="INTEGER" property="type"/>
    <result column="post_id" jdbcType="INTEGER" property="postId"/>
    <result column="content" jdbcType="VARCHAR" property="content"/>
    <result column="book_id" jdbcType="INTEGER" property="bookId"/>
    <result column="author_id" jdbcType="INTEGER" property="authorId"/>
    <result column="block_id" jdbcType="INTEGER" property="blockId"/>
    <result column="order" jdbcType="INTEGER" property="order"/>
  </resultMap>

  <!-- 帖子详情：post 元信息（association）+ 内容块列表（按 order 升序） -->
  <resultMap id="DetailResultMap" type="com.pool.readio.admin.dto.CmsPostDetail">
    <association property="post" resultMap="PostBaseResultMap"/>
    <collection property="contentBlocks" ofType="com.pool.readio.mbg.model.CmsPostContentBlock"
                select="listContentBlocksByPostId" column="id"/>
  </resultMap>

  <sql id="Post_Column_List">
    id, member_id, visible, create_time, update_time, publish_time, title, ip, address
  </sql>

  <sql id="Content_Block_Column_List">
    id, type, post_id, content, book_id, author_id, block_id, "order"
  </sql>

  <select id="getDetail" resultMap="DetailResultMap">
    SELECT <include refid="Post_Column_List"/>
    FROM public.cms_post
    WHERE id = #{id,jdbcType=INTEGER}
  </select>

  <!-- 按 post_id 查询内容块，按 order 升序（PostgreSQL 保留字用双引号） -->
  <select id="listContentBlocksByPostId" resultMap="ContentBlockResultMap">
    SELECT <include refid="Content_Block_Column_List"/>
    FROM public.cms_post_content_block
    WHERE post_id = #{id,jdbcType=INTEGER}
    ORDER BY "order" ASC
  </select>
</mapper>
