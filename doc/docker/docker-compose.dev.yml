services:
  postgres:
    image: postgres:latest
    container_name: readio-postgres-dev
    environment:
      POSTGRES_USER: readio
      POSTGRES_PASSWORD: readio
      POSTGRES_DB: readio
    ports:
      - "26001:5432"
    volumes:
      - readio_postgres_data:/var/lib/postgresql
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U readio -d readio"]
      interval: 5s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: readio-redis-dev
    command: redis-server /usr/local/etc/redis/redis.conf
    ports:
      - "26002:6379"
    volumes:
      - readio_redis_data:/data
      - ./redis.conf:/usr/local/etc/redis/redis.conf:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "-u", "redis://readio:readio@localhost:6379", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  # 与本地 docker run 成功参数一致：standalone + 内嵌 Derby，无 MySQL
  nacos:
    image: nacos/nacos-server:latest
    container_name: readio-nacos-dev
    hostname: nacos
    environment:
      - MODE=standalone
      - NACOS_AUTH_TOKEN=VGhpc0lzQVNlY3JldEtleUZvck5hY29zRGV2RW52aXJvbm1lbnQ=
      - NACOS_AUTH_IDENTITY_KEY=readio-nacos-dev
      - NACOS_AUTH_IDENTITY_VALUE=readio-nacos-dev
    ports:
      - "8080:8080"
      - "8848:8848"
      - "9848:9848"
    volumes:
      - readio_nacos_logs:/home/nacos/logs
      - readio_nacos_data:/home/nacos/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://127.0.0.1:8848/nacos/v1/console/health/readiness || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  logstash:
    image: docker.elastic.co/logstash/logstash:8.19.0
    container_name: readio-logstash-dev
    environment:
      # 开发环境限制 JVM 堆，避免占满内存
      LS_JAVA_OPTS: "-Xms256m -Xmx512m"
    ports:
      - "4560:4560"
      - "4561:4561"
      - "4562:4562"
      - "4563:4563"
    volumes:
      - ./logstash/readio.conf:/usr/share/logstash/pipeline/readio.conf:ro
    restart: unless-stopped

volumes:
  readio_postgres_data:
  readio_redis_data:
  readio_nacos_logs:
  readio_nacos_data:
