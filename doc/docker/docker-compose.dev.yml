services:
  postgres:
    image: postgres:latest
    container_name: readio-postgres-dev
    environment:
      POSTGRES_USER: readio
      POSTGRES_PASSWORD: readio
      POSTGRES_DB: readio
    ports:
      - "26001:5432"
    volumes:
      - readio_postgres_data:/var/lib/postgresql
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U readio -d readio"]
      interval: 5s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: readio-redis-dev
    command: redis-server /usr/local/etc/redis/redis.conf
    ports:
      - "26002:6379"
    volumes:
      - readio_redis_data:/data
      - ./redis.conf:/usr/local/etc/redis/redis.conf:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "-u", "redis://readio:readio@localhost:6379", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  nacos:
    image: nacos/nacos-server:v2.3.0
    container_name: readio-nacos-dev
    environment:
      MODE: standalone
      PREFER_HOST_MODE: hostname
      SPRING_DATASOURCE_PLATFORM: ""
      NACOS_AUTH_ENABLE: "false"
      JVM_XMS: 256m
      JVM_XMX: 512m
      NACOS_SERVER_IP: 0.0.0.0
    ports:
      - "8848:8848"
      - "9848:9848"
      - "9849:9849"
    volumes:
      - readio_nacos_data:/home/nacos
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://127.0.0.1:8848/nacos/v1/console/health/readiness || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  logstash:
    image: docker.elastic.co/logstash/logstash:8.19.0
    container_name: readio-logstash-dev
    environment:
      # 开发环境限制 JVM 堆，避免占满内存
      LS_JAVA_OPTS: "-Xms256m -Xmx512m"
    ports:
      - "4560:4560"
      - "4561:4561"
      - "4562:4562"
      - "4563:4563"
    volumes:
      - ./logstash/readio.conf:/usr/share/logstash/pipeline/readio.conf:ro
    restart: unless-stopped

volumes:
  readio_postgres_data:
  readio_redis_data:
  readio_nacos_data:
